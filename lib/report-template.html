<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>%reportName%: kbn-alert-load report</title>
  <link rel="shortcut icon" href="https://elastic.co/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <!--
  <script src="https://cdn.jsdelivr.net/npm/vega@5/build/vega.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4/build/vega-lite.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6/build/vega-embed.js"></script>
  -->
  
  <style>
    td {
      padding-top: 0;
      padding-bottom: 0;
    }
    .viz {
      width: 100%;
      padding: 1em 2em;
    }
  </style>
</head>

<body>
  <h1>kbn-alert-load report: %reportName%</h1>

  <table>
    <tr><td>date:</td><td>%date%</td></tr>
    <tr><td>version:</td><td>%version%</td></tr>
    <tr><td>zone:</td><td>%zone%</td></tr>
    <tr><td>alerts:</td><td>%alerts%</td></tr>
  </table>

  <p>Alerts are running at 1 minute intervals, and not scheduling any actions.</p>

  <p>
    The <i>eMxN kMxN</i> titles indicate the "size" of the deployments:
    <ul>
      <li>e<b>M</b>x<b>N</b> :: <b>M</b> elasticsearch instances using <b>N</b> GB RAM</li>
      <li>k<b>M</b>x<b>N</b> :: <b>M</b> kibana instances using <b>N</b> GB RAM</li>
    </ul>
  </p>

  <div class="viz" id="vis-executions-per-minute"></div>
  <div class="viz" id="vis-execution-time"></div>
  <div class="viz" id="vis-time-between-alert-executions"></div>
  <div class="viz" id="vis-kb-status"></div>
  <div class="viz" id="vis-es-status"></div>

  <p><i>generated by <a href='https://github.com/pmuellr/kbn-alert-load'>kbn-alert-load</a></i></p>
</body>

<script>
  const { eventLog, kbStatus, esStatus } = getAllData()
  const chartWidth = 200
  const colors = [
    '#00BFB3',
    '#F04E98',
    '#1BA9F5',
    '#0077CC',
  ]

  const earliestDate = Date.parse(eventLog[0].date)

  // augment the eventLog
  eventLog.forEach(event => {
    const [index, ...rest] = event.deployment.split(/-/g).slice(2)
      event.deployment = `${index}: ${rest.join(' ')}`
      event.dateNumber = Date.parse(event.date)
      event.dateRelative = event.dateNumber - earliestDate
      event.minute = event.dateRelative / 1000 / 60
  })

  // augment the kbStatus
  kbStatus.forEach(status => {
    const [index, ...rest] = status.deployment.split(/-/g).slice(2)
      status.deployment = `${index}: ${rest.join(' ')}`
      status.dateNumber = Date.parse(status.metrics.last_updated)
      status.dateRelative = status.dateNumber - earliestDate
      status.minute = status.dateRelative / 1000 / 60
  })

  // augment the esStatus
  esStatus.forEach(status => {
    const [index, ...rest] = status.deployment.split(/-/g).slice(2)
      status.deployment = `${index}: ${rest.join(' ')}`
      status.dateNumber = Date.parse(status.date)
      status.dateRelative = status.dateNumber - earliestDate
      status.minute = status.dateRelative / 1000 / 60

      status.heapPercent = parseInt(status['heap.percent'], 10)
      status.ramPercent = parseInt(status['ram.percent'], 10)
      status.cpuPercent = parseInt(status.cpu, 10)
  })

  const lastExecutions = new Map()
  eventLog.forEach(event => {
    if (!event.alert) return

    const key = `${event.deployment}-${event.alert}`
    const lastExecution = lastExecutions.get(key)
    if (lastExecution) {
      event.lastInterval = (event.dateNumber - lastExecution) / 1000 / 60
    }
    lastExecutions.set(key, event.dateNumber)
  })

  vegaEmbed('#vis-execution-time', {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    title: 'execution time',
    width: chartWidth,
    mark: { 
      type: 'point', 
      shape: 'square',
      size: 1,
      strokeWidth: 1,
      opacity: 0.4,
      color: colors[0],
      tooltip: true
    },
    encoding: {
      x: {
        title: 'minutes since start',
        field: 'dateRelative',
        type: 'temporal',
        axis: {
          format: '%-M',
          formatType: 'time',
          tickCount: 'minute',
        }
      },
      y: {
        title: 'execution time (milliseconds)',
        field: 'duration',
        type: 'quantitative',
        scale: { zero: true, type: 'log' },
        axis: { grid: false }
      },
      column: {
        field: 'deployment',
        header: { title: null },
      }
    },
    data: { values: eventLog }
  })

  vegaEmbed('#vis-time-between-alert-executions', {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    title: 'times between alert executions',
    width: chartWidth,
    mark: { 
      type: 'point', 
      shape: 'square',
      size: 1,
      strokeWidth: 1,
      opacity: 0.4,
      color: colors[1],
      tooltip: true
    },
    encoding: {
      x: {
        title: 'minutes since start',
        field: 'dateRelative',
        type: 'temporal',
        axis: {
          format: '%-M',
          formatType: 'time',
          tickCount: 'minute',
        }
      },
      y: {
        title: 'last execution (minutes)',
        field: 'lastInterval',
        type: 'quantitative',
        scale: { zero: true },
        axis: { grid: false }
      },
      column: {
        field: 'deployment',
        header: { title: null },
      }
    },
    data: { values: eventLog }
  })

  vegaEmbed('#vis-executions-per-minute', {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    title: 'executions per minute',
    width: chartWidth,
    mark: { 
      type: 'bar', 
      tooltip: true, 
      cornerRadiusEnd: 4,
      color: colors[2],
    },
    encoding: {
      x: {
        bin: { step: 1 },
        field: 'minute',
        type: 'ordinal',
        title: 'minutes since start (binned)',
      },
      y: {
        title: 'executions',
        aggregate: 'count',
      },
      column: {
        field: 'deployment',
        header: { title: null },
      }
    },
    data: { values: eventLog }
  })

  vegaEmbed('#vis-kb-status', {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    title: 'kibana metrics',
    data: { values: kbStatus },
    hconcat: [
      metricSpec('load avg (1m)', 'metrics.os.load.1m'),
      metricSpec('event loop delay', 'metrics.process.event_loop_delay'),
      metricSpec('rss', 'metrics.process.memory.resident_set_size_in_bytes'),
    ]
  })

  vegaEmbed('#vis-es-status', {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    title: 'elasticsearch metrics',
    data: { values: esStatus },
    hconcat: [
      metricSpec('heap %', 'heapPercent'),
      metricSpec('ram %', 'ramPercent'),
      metricSpec('cpu', 'cpuPercent'),
    ]
  })

  function metricSpec(title, field) {
    return {
      title,
      width: chartWidth,
      mark: { 
        type: 'line', 
        opacity: 0.6,
        tooltip: true
      },
      encoding: {
        x: {
          title: 'minutes since start',
          field: 'dateRelative',
          type: 'temporal',
          axis: {
            format: '%-M',
            formatType: 'time',
            tickCount: 'minute',
          }
        },
        y: {
          title: null,
          field,
          type: 'quantitative',
          scale: { zero: true },
          axis: { grid: false }
        },
        color: {
          field: 'deployment',
          scheme: 'set1',
        },
      },
    }
  }

  function getAllData() {
    const data = 
    // data-start
    {
      eventLog: ["%EventLog%"],
      kbStatus: ["%KbStatus%"],
      esStatus: ["%EsStatus%"],
    }
    // data-end

    return data
  }
</script>

</html>
