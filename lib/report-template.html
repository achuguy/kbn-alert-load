<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>kbn-alert-load %runName% report for %alerts% alerts</title>
  <link rel="shortcut icon" href="https://elastic.co/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    td {
      padding-top: 0;
      padding-bottom: 0;
    }
  </style>
</head>

<body>
  <h1>kbn-alert-load %runName% report for %alerts% alerts</h1>

  <table>
    <tr><td>date:</td><td>%date%</td></tr>
    <tr><td>version:</td><td>%version%</td></tr>
    <tr><td>zone:</td><td>%zone%</td></tr>
  </table>

  <h2>execution times</h2>
  <div id="vis-execution-time"></div>

  <h2>executions per minute</h2>
  <div id="vis-executions-per-minute"></div>

  <hr>

  <p>Alerts are running at 1 minute intervals, and not scheduling any actions.</p>

  <p>
    The <i>eMxN kMxN</i> titles indicate the "size" of the deployments:
    <ul>
      <li>eMxN means <b>M</b> elasticsearch instances using <b>N</b> GB RAM</li>
      <li>kMxN means <b>M</b> kibana instances using <b>N</b> GB RAM</li>
    </ul>
  </p>

  <p><i>generated by <a href='https://github.com/pmuellr/kbn-alert-load'>kbn-alert-load</a></i></p>
</body>

<script>
  const allEvents = getEventLog()

  const earliestDate = allEvents
    .map(event => Date.parse(event.date))
    .sort()
    [0]

  const events = allEvents
    .map(event => {
      event.deployment = event.deployment.split(/-/g).slice(2).join(' ')
      event.duration = event.duration / 1000
      event.dateRelative = Date.parse(event.date) - earliestDate
      event.minute = event.dateRelative / 1000 / 60
      return event
    })

  const specExecutionTime = {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    mark: { 
      type: 'point', 
      shape: 'stroke',
      size: 50,
      strokeWidth: 1,
      opacity: 0.4,
      xOffset: 4,
      tooltip: true
    },
    encoding: {
      x: {
        title: 'minutes since start',
        field: 'dateRelative',
        type: 'temporal',
        axis: {
          format: '%-M',
          formatType: 'time',
          tickCount: 'minute',
        }
      },
      y: {
        title: 'execution time (seconds)',
        field: 'duration',
        type: 'quantitative',
        scale: { zero: true, type: 'log' },
        axis: { grid: false }
      },
      column: {
        field: 'deployment'
      }
    },
    data: { values: events }
  }

  const specExecutionsPerMinute = {
    $schema: 'https://vega.github.io/schema/vega-lite/v4.json',
    mark: { type: 'bar', tooltip: true},
    encoding: {
      x: {
        bin: { step: 1 },
        field: 'minute',
        type: 'ordinal',
        title: 'minutes since start (binned)',
      },
      y: {
        title: 'executions',
        aggregate: 'count',
      },
      column: {
        field: 'deployment'
      }
    },
    data: { values: events }
  }

  vegaEmbed('#vis-execution-time', specExecutionTime);
  vegaEmbed('#vis-executions-per-minute', specExecutionsPerMinute);

  function getEventLog() {
    return ["%EventLog%"]
  }
</script>

</html>
